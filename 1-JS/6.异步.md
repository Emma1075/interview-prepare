# 异步

## JS运行机制

### 同步任务和异步任务的优先关系
同步任务执行完毕前，异步任务不会被执行。


### 异步任务的放入时间和执行时间
队列插入的时间
异步队列执行的时间

### 如何理解 JS 的单线程
一个时间内，JS 只能做一件事。

### 什么是任务队列
JS 分同步任务和异步任务。优先处理同步任务，再处理异步任务。

### 什么是 Event Loop
事件循环

- 同步任务：调用立即得到结果的任务，同步任务在主线程上排队执行的任务，只有前一个任务执行完毕，才能执行后一个任务；

- 异步任务是调用无法立即得到结果，需要额外的操作才能预期结果的任务，异步任务不进入主线程、而进入"任务队列"（task queue）的任务，只有"任务队列"通知主线程，某个异步任务可以执行了，该任务才会进入主线程执行。

JS引擎遇到异步任务（DOM事件监听、网络请求、setTimeout计时器等），会交给相应的线程单独去维护异步任务，等待某个时机（计时器结束、网络请求成功、用户点击DOM），然后由 `事件触发线程` 将异步对应的 `回调函数` 加入到消息队列中，消息队列中的回调函数等待被执行。

具体来说，异步运行机制如下：

（1）所有同步任务都在主线程上执行，形成一个[执行栈]

（2）主线程之外，还存在一个"任务队列"（task queue）。只要异步任务有了运行结果，就在"任务队列"之中放置一个事件。

（3）一旦"执行栈"中的所有同步任务执行完毕，系统就会读取"任务队列"，看看里面有哪些事件。那些对应的异步任务，于是结束等待状态，进入执行栈，开始执行。

（4）主线程不断重复上面的第三步。

主线程从"任务队列"中读取事件，这个过程是循环不断的，所以整个的这种运行机制又称为Event Loop（事件循环）



### node event loop
node 事件循环

Node 中的 Event loop 和浏览器中的不相同。

Node 的 Event loop 分为 6 个阶段，它们会按照顺序反复运行


```
┌───────────────────────┐
┌─>│        timers         │
│  └──────────┬────────────┘
│  ┌──────────┴────────────┐
│  │     I/O callbacks     │
│  └──────────┬────────────┘
│  ┌──────────┴────────────┐
│  │     idle, prepare     │
│  └──────────┬────────────┘      ┌───────────────┐
│  ┌──────────┴────────────┐      │   incoming:   │
│  │         poll          │<──connections───     │
│  └──────────┬────────────┘      │   data, etc.  │
│  ┌──────────┴────────────┐      └───────────────┘
│  │        check          │
│  └──────────┬────────────┘
│  ┌──────────┴────────────┐
└──┤    close callbacks    │
   └───────────────────────┘
```


#### timer

timers 阶段会执行 setTimeout 和 setInterval

一个 timer 指定的时间并不是准确时间，而是在达到这个时间后尽快执行回调，可能会因为系统正在执行别的事务而延迟。



#### I/O
I/O 阶段会执行除了 close 事件，定时器和 setImmediate 的回调



#### idle, prepare
idle, prepare 阶段内部实现


#### poll
poll 阶段很重要，这一阶段中，系统会做两件事情

执行到点的定时器
执行 poll 队列中的事件


#### check
check 阶段执行 setImmediate


#### close callbacks
close callbacks 阶段执行 close 事件

并且在 Node 中，有些情况下的定时器执行顺序是随机的

### 宏任务与微任务

- MacroTask（宏任务）：* script全部代码、setTimeout、setInterval、setImmediate、I/O、UI Rendering。

- MicroTask（微任务）：* Process.nextTick（Node独有）、Promise、Object.observe(废弃)、MutationObserver
